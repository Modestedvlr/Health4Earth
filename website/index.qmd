---
title: "HEALTH4EARTH"
format: html
---

# Carte interactive

<div>
  <label for="indicator"><strong>Choisir un indicateur :</strong></label>
  <select id="indicator">
    <option value="co2">Émissions de CO₂</option>
    <option value="pollution">Mortalité pollution</option>
    <option value="life">Espérance de vie</option>
  </select>
</div>

<div id="map" style="height: 600px; margin-top: 15px;"></div>

<!-- Panneau latéral -->
<div id="panel" style="
  position: fixed;
  top: 80px;
  right: 20px;
  width: 420px;
  height: 500px;
  background: white;
  border-radius: 8px;
  padding: 12px;
  box-shadow: 0 0 10px rgba(0,0,0,0.25);
  overflow-y: auto;
  display: none;
  z-index: 999;
">
  <h3 id="panel-title"></h3>
  <div id="panel-plot" style="height: 350px;"></div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>

// =====================================================
// 1. INITIALISATION DE LA CARTE
// =====================================================
const map = L.map('map').setView([20, 0], 2);

// Fond OpenStreetMap
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap contributors'
}).addTo(map);

// Couleurs de remplissage
function getColor(d) {
  return d > 80 ? '#800026' :
         d > 50 ? '#BD0026' :
         d > 20 ? '#E31A1C' :
         d > 10 ? '#FC4E2A' :
         d > 5  ? '#FD8D3C' :
         d > 1  ? '#FEB24C' :
                  '#FFEDA0';
}

let datasets = {};
let worldLayer;
let currentIndicator = "co2";

// =====================================================
// 2. AFFICHAGE DU PANNEAU AVEC GRAPHIQUES
// =====================================================
function showCountryPanel(iso, countryData) {

  document.getElementById("panel-title").textContent = countryData.country;

  const series = countryData.series;
  const traces = [];

  if (series.co2) {
    traces.push({
      x: series.co2.years,
      y: series.co2.values,
      mode: "lines",
      name: "CO₂"
    });
  }

  if (series.pollution) {
    traces.push({
      x: series.pollution.years,
      y: series.pollution.values,
      mode: "lines",
      name: "Pollution atmosphérique"
    });
  }

  if (series.life) {
    traces.push({
      x: series.life.years,
      y: series.life.values,
      mode: "lines",
      name: "Espérance de vie"
    });
  }

  if (series.mortality) {
    traces.push({
      x: series.mortality.years,
      y: series.mortality.values,
      mode: "lines",
      name: "Mortalité pollution"
    });
  }

  Plotly.newPlot("panel-plot", traces, {
    title: "Évolution des indicateurs",
    margin: { t: 30 }
  });

  document.getElementById("panel").style.display = "block";
}

// =====================================================
// 3. CHARGEMENT DES DONNÉES JSON
// =====================================================

Promise.all([
  fetch("data/all_series.json").then(r => r.json()),
  fetch("data/world.geojson").then(r => r.json())
]).then(([allSeries, world]) => {

  datasets = allSeries;

  // --- Ajout des capitales ---
  Object.keys(allSeries).forEach(iso => {
    const p = allSeries[iso];
    if (p.lat && p.lon) {
      const marker = L.circleMarker([p.lat, p.lon], {
        radius: 5,
        color: "#333",
        fillColor: "#2b8",
        fillOpacity: 0.8
      }).addTo(map);

      marker.on("click", () => {
        showCountryPanel(iso, p);
      });
    }
  });

  // --- Style des pays ---
  function style(feature) {
    const iso = feature.properties.ISO_A3;
    const val = datasets[iso]?.latest?.[currentIndicator] ?? 0;
    return {
      fillColor: getColor(val),
      weight: 1,
      opacity: 1,
      color: "white",
      fillOpacity: 0.7
    };
  }

  // --- Ajout du GeoJSON ---
  worldLayer = L.geoJson(world, {
    style: style,
    onEachFeature: function (feature, layer) {
      const iso = feature.properties.ISO_A3;
      const val = datasets[iso]?.latest?.[currentIndicator] ?? "N/A";

      layer.bindPopup(`
        <b>${feature.properties.ADMIN}</b><br>
        ${currentIndicator.toUpperCase()} : ${val}
      `);
    }
  }).addTo(map);

  // --- Changement d’indicateur ---
  document.getElementById("indicator").addEventListener("change", function(e) {
    currentIndicator = e.target.value;

    worldLayer.eachLayer(function(layer) {
      layer.setStyle(style(layer.feature));

      const iso = layer.feature.properties.ISO_A3;
      const val = datasets[iso]?.latest?.[currentIndicator] ?? "N/A";

      layer.bindPopup(`
        <b>${layer.feature.properties.ADMIN}</b><br>
        ${currentIndicator.toUpperCase()} : ${val}
      `);
    });
  });

}).catch(err => {
  console.error("Erreur de chargement :", err);
});

</script>
