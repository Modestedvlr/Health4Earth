---
title: "health4earth"
format: 
  html:
    theme: cosmo
    toc: false
    page-layout: full
jupyter: python3
---

## Carte Interactive

```{python}
#| echo: false
#| warning: false
#| output: true

import folium
import base64
import io
import matplotlib.pyplot as plt
import pandas as pd
from health4earth.data_ingest import load_merged_data

# 1. Chargement
df = load_merged_data()

# 2. Fonction magique : Générer un graphique en Base64 (Image texte)
def get_graph_base64(country_name):
    """Génère un graphique d'évolution pour un pays et le retourne en Base64 pour HTML."""
    country_data = df[df['country'] == country_name]
    if country_data.empty or len(country_data) < 5:
        return None
        
    # Création du graphique (Petit format pour le popup)
    plt.figure(figsize=(4, 2.5))
    plt.plot(country_data['year'], country_data['co2'], color='red', linewidth=2)
    plt.title(f"Évolution CO2: {country_name}", fontsize=10)
    plt.xlabel("Année", fontsize=8)
    plt.ylabel("Mt CO2", fontsize=8)
    plt.tight_layout()
    
    # Sauvegarde en mémoire
    img = io.BytesIO()
    plt.savefig(img, format='png', transparent=True)
    img.seek(0)
    
    # Encodage
    return base64.b64encode(img.getvalue()).decode()

# 3. Préparation de la carte
m = folium.Map(location=[20, 0], zoom_start=2, tiles="CartoDB positron")

# Liste des pays clés avec leurs coordonnées
capitals = {
    'France': [48.85, 2.35], 'United States': [38.90, -77.03],
    'China': [39.90, 116.40], 'India': [28.61, 77.20],
    'Brazil': [-15.78, -47.92], 'Germany': [52.52, 13.40],
    'Russia': [55.75, 37.61], 'Japan': [35.67, 139.65]
}

for country, coords in capitals.items():
    # Génération du graphique
    b64_img = get_graph_base64(country)
    
    # Création du HTML pour le popup
    if b64_img:
        html = f"""
        <div style="width:300px; text-align:center;">
            <h4>{country}</h4>
            <img src="data:image/png;base64,{b64_img}" width="280">
            <br>
            <a href="predictions.html" target="_top">Voir prédictions complètes ➡️</a>
        </div>
        """
        iframe = folium.IFrame(html, width=320, height=250)
        popup = folium.Popup(iframe, max_width=350)
        
        folium.Marker(
            location=coords,
            popup=popup,
            icon=folium.Icon(color="red", icon="stats")
        ).add_to(m)

m
```