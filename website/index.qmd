---
title: "Accueil"
format: 
  html:
    page-layout: custom
    toc: false
jupyter: python3
---

::: {.grid}
::: {.g-col-12 .text-center style="background-color: #f8f9fa; padding: 15px; border-bottom: 1px solid #ddd;"}
### Observatoire Health4Earth
**Cliquez sur un pays pour visualiser son Bilan Sant√© & Climat**
:::
:::

```{python}
#| echo: false
#| warning: false
#| output: false

# --- BLOC 1 : CALCULS (Cach√© pour √©viter les textes parasites) ---
import folium
import requests
import matplotlib.pyplot as plt
import io
import base64
import pandas as pd
import json
from health4earth.data_ingest import load_merged_data

# On emp√™che l'affichage intempestif des graphiques matplotlib
plt.ioff()

# Chargement des donn√©es
df = load_merged_data()

# Fonction de g√©n√©ration du graphique popup
def get_graph_b64(iso_code, country_name):
    data = df[df['iso_code'] == iso_code]
    if len(data) < 5: return None
    
    fig, ax1 = plt.subplots(figsize=(5, 3))
    
    # Axe Gauche
    l1, = ax1.plot(data['year'], data['co2'], color='grey', label='CO2', linewidth=2)
    l2, = ax1.plot(data['year'], data['pollution_deaths'], color='red', linestyle='--', label='D√©c√®s')
    ax1.set_ylabel('Volume', fontsize=8)
    ax1.tick_params(axis='y', labelsize=8)
    
    # Axe Droit
    ax2 = ax1.twinx()
    l3, = ax2.plot(data['year'], data['life_expectancy'], color='green', linewidth=2, label='Vie')
    l4, = ax2.plot(data['year'], data['pollution_concentration'], color='orange', linestyle=':', label='Poll.')
    ax2.set_ylabel('Indices', fontsize=8)
    ax2.tick_params(axis='y', labelsize=8)
    
    plt.title(f"Bilan : {country_name}", fontsize=10, fontweight='bold')
    
    lines = [l1, l2, l3, l4]
    labels = [l.get_label() for l in lines]
    ax1.legend(lines, labels, loc='upper center', bbox_to_anchor=(0.5, 1.15), ncol=4, fontsize=7, frameon=False)
    
    plt.tight_layout()
    img = io.BytesIO()
    plt.savefig(img, format='png', bbox_inches='tight')
    img.seek(0)
    plt.close(fig)
    return base64.b64encode(img.getvalue()).decode()

# R√©cup√©ration GeoJSON
geo_url = "https://raw.githubusercontent.com/python-visualization/folium/master/examples/data/world-countries.json"
geo_data = requests.get(geo_url).json()
```

```{python}
#| echo: false
#| warning: false
#| output: true

# --- BLOC 2 : AFFICHAGE CARTE (Visible) ---

# Configuration de la carte statique
m = folium.Map(
    location=[25, 0], 
    zoom_start=2, 
    tiles="CartoDB positron", 
    height="85vh", 
    width="100%",
    zoom_control=False,
    scrollWheelZoom=False,
    dragging=False,
    doubleClickZoom=False,
    boxZoom=False
)

# Liste des pays disponibles dans nos donn√©es
available_isos = df['iso_code'].unique()

# Styles
style_invisible = {'fillColor': '#3388ff', 'color': '#3388ff', 'weight': 1, 'fillOpacity': 0.0}
style_highlight = {'fillColor': '#3388ff', 'color': 'black', 'weight': 2, 'fillOpacity': 0.4}

for feature in geo_data['features']:
    country_iso = feature['id']
    country_name = feature['properties']['name']
    
    # On ajoute uniquement les pays qu'on conna√Æt
    if country_iso in available_isos:
        b64 = get_graph_b64(country_iso, country_name)
        
        if b64:
            html = f"""
            <div style="text-align:center; width: 400px;">
                <img src="data:image/png;base64,{b64}" width="100%">
            </div>
            """
            iframe = folium.IFrame(html, width=420, height=320)
            popup = folium.Popup(iframe, max_width=450)
            
            folium.GeoJson(
                feature,
                style_function=lambda x: style_invisible,
                highlight_function=lambda x: style_highlight,
                popup=popup,
                tooltip=f"üìä {country_name}"
            ).add_to(m)

m
```